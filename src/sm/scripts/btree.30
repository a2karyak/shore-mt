#
# This script demonstrates a bug which occurs
# when four threads try inserting entries to 
# the same btree at the same time. 

# WARNING: this runs for a long time 
#

source $script_dir/vol.init

set ntries 16
set nxct 100

proc go_go_gadget {name ndx seed} {
    global ntries volid nxct short_form
    for {set j 1} {$j <= $nxct} {incr j} {
	sm begin_xct
	for {set i 1} {$i <= $ntries} {incr i} {
#	    set f1 [sm create_file $volid]
	    # echo $name sleeping 1...
	    # sm sleep 1
	    sm create_assoc $ndx [format $short_form [expr {$i + $seed * $ntries} ] ]  $j
	    echo thread $name: created entry [expr {$i + $seed * $ntries} ] "->" $j
#	    sm create_assoc $ndx 10 $j
	}
	sm commit_xct
    }
}

echo starting 4 threads

sm begin_xct
set ndx [sm create_index $volid btree]
sm commit_xct

set t1 [fork_thread go_go_gadget {"t1" $ndx "1"} ]
set t2 [fork_thread go_go_gadget {"t2" $ndx "2"} ]
set t3 [fork_thread go_go_gadget {"t3" $ndx "4"} ]
set t4 [fork_thread go_go_gadget {"t4" $ndx "3"} ]

echo waiting for threads

join_thread $t1 $t2 $t3 $t4

sm begin_xct
sm destroy_index $ndx
sm commit_xct

echo threads done


unset t1 t2 t3 t4
unset ntries nxct ndx
